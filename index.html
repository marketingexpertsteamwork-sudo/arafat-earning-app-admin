<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Control Panel</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --sidebar-width: 250px;
            --topbar-height: 60px;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            transition: margin-left 0.3s ease-in-out;
        }
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: var(--sidebar-width);
            background-color: #1c293a;
            color: #f0f2f5;
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 1100;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        body.sidebar-open .sidebar {
            transform: translateX(0);
        }
        .sidebar-header {
            padding: 18px 20px;
            font-size: 1.5rem;
            font-weight: 700;
            border-bottom: 1px solid #3a4a5d;
        }
        .sidebar-header i { margin-right: 10px; }
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }
        .sidebar-menu li a {
            display: block;
            padding: 15px 20px;
            color: #f0f2f5;
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.3s, padding-left 0.3s;
        }
        .sidebar-menu li a:hover, .sidebar-menu li a.active {
            background-color: #4A90E2;
            padding-left: 25px;
        }
        .sidebar-menu li a i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }
        .main-content {
            flex-grow: 1;
            width: 100%;
        }
        .topbar {
            height: var(--topbar-height);
            background: #fff;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .menu-toggle-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #1c293a;
            margin-right: 20px;
        }
        .topbar-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1c293a;
        }
        .content-wrapper {
            padding: 20px;
        }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .container { max-width: 1200px; margin: auto; }
        h2, h3 { color: #1c293a; padding-bottom: 10px; margin-bottom: 20px; }
        h2 { border-bottom: 2px solid #4A90E2; font-size: 1.5rem; }
        h3 { font-size: 1.2rem; color: #333; border-bottom: 1px solid #ddd; margin-top: 25px; }
        .grid-container { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        .card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .user-list, .withdrawal-list { max-height: 500px; overflow-y: auto; }
        .list-item { padding: 12px; border-bottom: 1px solid #e0e0e0; cursor: pointer; transition: background-color 0.2s; }
        .list-item:hover { background-color: #f7f7f7; }
        .list-item.active { background-color: #e9f2fe; font-weight: 600; }
        .list-item-header { font-weight: 600; font-size: 0.9rem; word-break: break-all; }
        .list-item-subheader { font-size: 0.8rem; color: #666; word-break: break-all; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .btn { padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 10px; margin-top: 5px; transition: all 0.2s ease; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background-color: #4A90E2; color: white; }
        .btn-danger { background-color: #E64A4A; color: white; }
        .btn-success { background-color: #50E3C2; color: #333; }
        .btn-warning { background-color: #F5A623; color: white; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        #login-box { background: white; padding: 30px; border-radius: 12px; text-align: center; width: 90%; max-width: 350px; }
        #login-box input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .dashboard-item { background-color: #f9f9f9; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #e0e0e0; }
        .dashboard-item .value { font-size: 1.8rem; font-weight: 700; color: #4A90E2; }
        .dashboard-item .label { font-size: 0.85rem; color: #666; }
        .detail-section { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .history-list { max-height: 200px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; background: #fafafa; }
        .history-item { font-size: 0.85rem; padding: 5px 0; border-bottom: 1px solid #f0f0f0; }
        #sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1099; }
        body.sidebar-open #sidebar-overlay { display: block; }
        .tab-nav { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .tab-nav-item { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-nav-item.active { border-bottom-color: var(--primary-color); color: var(--primary-color); font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        @media (max-width: 768px) { .grid-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body id="adminBody">

    <div id="login-overlay">
        <div id="login-box">
            <h2>Admin Login</h2>
            <input type="password" id="adminPassword" placeholder="Enter Password">
            <button class="btn btn-primary" onclick="login()">Login</button>
        </div>
    </div>

    <div class="admin-layout" id="adminContainer" style="display:none;">
        <div id="sidebar-overlay" onclick="toggleSidebar()"></div>
        <div class="sidebar" id="sidebar">
            <h1 class="sidebar-header"><i class="fas fa-user-shield"></i> Admin</h1>
            <ul class="sidebar-menu">
                <li><a href="#" class="menu-item" data-section="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="#" class="menu-item" data-section="users"><i class="fas fa-users"></i> Users</a></li>
                <li><a href="#" class="menu-item" data-section="withdrawals"><i class="fas fa-hand-holding-usd"></i> Withdrawals</a></li>
                <li><a href="#" class="menu-item" data-section="bonus"><i class="fas fa-gift"></i> Bonus Channels</a></li>
                <li><a href="#" class="menu-item" data-section="settings"><i class="fas fa-cogs"></i> App Settings</a></li>
            </ul>
        </div>

        <div class="main-content">
            <div class="topbar">
                <button id="menuToggleBtn" class="menu-toggle-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                <h1 id="topbarTitle" class="topbar-title">Welcome</h1>
            </div>
            <div class="content-wrapper">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="content-section">
                    <div class="card">
                        <div class="dashboard-grid">
                            <div class="dashboard-item"><div class="value" id="analyticsTotalUsers">0</div><div class="label">Total Users</div></div>
                            <div class="dashboard-item"><div class="value" id="analyticsNewUsersToday">0</div><div class="label">New Users Today</div></div>
                            <div class="dashboard-item"><div class="value" id="analyticsPendingWithdrawals">0</div><div class="label">Pending Withdrawals</div></div>
                            <div class="dashboard-item"><div class="value" id="analyticsTotalPoints">0</div><div class="label">Total Points in System</div></div>
                        </div>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="users-section" class="content-section">
                     <h2><i class="fas fa-users"></i> User Management</h2>
                     <div class="grid-container">
                        <div class="card">
                            <h3>All Users (<span id="userCount">0</span>)</h3>
                            <input type="text" id="userSearch" placeholder="Search by name or ID..." onkeyup="renderUsersList()">
                            <div class="user-list" id="usersListContainer"></div>
                        </div>
                        <div id="userDetailsCard" style="display:none;">
                            <div class="card">
                                <h3>User Details</h3>
                                <div class="form-group"><label>User ID</label><input type="text" id="detailUserId" readonly></div>
                                <div class="form-group"><label>Name</label><input type="text" id="detailUserName"></div>
                                <div class="form-group"><label>Points</label><input type="number" id="detailUserPoints"></div>
                                <!-- নতুন যুক্ত করা হয়েছে: লেভেল এবং XP ম্যানেজমেন্ট -->
                                <div style="display: flex; gap: 10px;">
                                    <div class="form-group" style="flex: 1;"><label>Level</label><input type="number" id="detailUserLevel"></div>
                                    <div class="form-group" style="flex: 1;"><label>XP</label><input type="number" id="detailUserXp"></div>
                                </div>
                                <button class="btn btn-primary" onclick="saveUserDetails()">Save Changes</button>
                                <button class="btn btn-warning" id="blockUserBtn" onclick="toggleBlockUser()">Block User</button>
                                <button class="btn btn-danger" onclick="deleteUser()">Delete User</button>
                            </div>
                             <div class="card">
                                <h3><i class="fas fa-envelope"></i> Send Personal Notice</h3>
                                <div class="form-group">
                                    <textarea id="personalNoticeMessage" rows="3" placeholder="Write a short message..."></textarea>
                                </div>
                                <button class="btn btn-primary" onclick="sendPersonalNotice()">Send Notice</button>
                            </div>
                            <div class="card">
                                <h3>Additional Info</h3>
                                <p><strong>Registration Date:</strong> <span id="detailUserRegistrationDate">N/A</span></p>
                                <p><strong>Last Seen:</strong> <span id="detailUserLastLogin">N/A</span></p>
                                <h4>Referral History (<span id="detailUserReferralCount">0</span>)</h4>
                                <div class="history-list" id="detailUserReferralHistory"><p>No referrals yet.</p></div>
                                <!-- নতুন যুক্ত করা হয়েছে: ট্রানজেকশন লগ -->
                                <h4>Transaction Log</h4>
                                <div class="history-list" id="detailUserTransactionHistory"><p>No transaction history.</p></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Withdrawals Section (পরিবর্তিত কোড) -->
                <div id="withdrawals-section" class="content-section">
                    <h2><i class="fas fa-hand-holding-usd"></i> Withdrawal Requests</h2>
                    <div class="card">
                        <div class="tab-nav" id="withdrawalTabNav">
                            <div class="tab-nav-item active" data-status="pending">Pending (<span id="withdrawalCountPending">0</span>)</div>
                            <div class="tab-nav-item" data-status="paid">Paid (<span id="withdrawalCountPaid">0</span>)</div>
                            <div class="tab-nav-item" data-status="rejected">Rejected (<span id="withdrawalCountRejected">0</span>)</div>
                        </div>
                        
                        <div id="withdrawalTabContentPending" class="tab-content active withdrawal-list"></div>
                        <div id="withdrawalTabContentPaid" class="tab-content withdrawal-list"></div>
                        <div id="withdrawalTabContentRejected" class="tab-content withdrawal-list"></div>
                    </div>
                </div>

                <!-- Bonus Section -->
                <div id="bonus-section" class="content-section">
                     <h2><i class="fas fa-gift"></i> Bonus Channel Management</h2>
                    <div class="card">
                        <h3>Existing Channels</h3>
                        <div class="bonus-channel-list" id="bonusChannelsListContainer"></div>
                    </div>
                    <div class="card">
                        <h3>Add or Edit Channel</h3>
                        <div class="form-group"><label>ID (unique)</label><input type="text" id="bonusId" placeholder="e.g., tg_channel_3"></div>
                        <div class="form-group"><label>Name</label><input type="text" id="bonusName" placeholder="Channel Name"></div>
                        <div class="form-group"><label>Link</label><input type="text" id="bonusLink" placeholder="https://t.me/channel"></div>
                        <div class="form-group"><label>Reward</label><input type="number" id="bonusReward" placeholder="e.g., 50"></div>
                        <div class="form-group"><label>Icon</label><input type="text" id="bonusIcon" placeholder="fas fa-gift"></div>
                        <button class="btn btn-primary" onclick="saveBonusChannel()">Add New Channel</button>
                    </div>
                </div>
                
                <!-- Settings Section (পরিবর্তিত কোড) -->
                <div id="settings-section" class="content-section">
                    <h2><i class="fas fa-cogs"></i> Global App Settings</h2>
                    <div class="card">
                        <h3>General Settings</h3>
                        <div class="form-group"><label>App Name</label><input type="text" id="settingAppName"></div>
                        <div class="form-group"><label>App Version</label><input type="text" id="settingAppVersion" placeholder="e.g., 1.0"></div>
                        <div class="form-group"><label>Developer Profile Link</label><input type="text" id="settingDevLink"></div>
                        <div class="form-group"><label>Official Channel Link</label><input type="text" id="settingOfficialChannelLink"></div>
                        <div class="form-group"><label>Support Group Link</label><input type="text" id="settingSupportGroupLink"></div>
                        <div class="form-group"><label>Referral Bot Link</label><input type="text" id="settingRefBotLink"></div>
                        <button class="btn btn-success" onclick="saveGeneralSettings()">Save General Settings</button>
                    </div>
                    <div class="card">
                        <h3>Points & Ad Settings</h3>
                        <div class="form-group"><label>Points Per Ad</label><input type="number" id="settingPointsPerAd"></div>
                        <div class="form-group"><label>Ads Per Day Limit</label><input type="number" id="settingAdsPerDay"></div>
                        <div class="form-group"><label>Minimum Withdraw Points</label><input type="number" id="settingMinWithdraw"></div>
                        <div class="form-group"><label>Daily Bonus Amount</label><input type="number" id="settingDailyBonus"></div> <!-- নতুন -->
                        <div class="form-group"><label>Referral Bonus (for Referrer)</label><input type="number" id="settingRefBonusReferrer"></div>
                        <div class="form-group"><label>Referral Bonus (for Referee)</label><input type="number" id="settingRefBonusReferee"></div>
                        <div class="form-group"><label>Monetag Ad Zone ID</label><input type="text" id="settingMonetagZoneId"></div>
                        <button class="btn btn-success" onclick="savePointsSettings()">Save Points & Ad Settings</button>
                    </div>
                    <!-- নতুন যুক্ত করা হয়েছে: লেভেলিং সিস্টেম ম্যানেজমেন্ট -->
                    <div class="card">
                        <h3>Leveling System</h3>
                        <div class="form-group"><label>XP Per Ad</label><input type="number" id="settingXpPerAd"></div>
                        <div class="form-group">
                            <label>Level Thresholds (JSON format)</label>
                            <textarea id="settingLevelConfig" rows="5" placeholder='[{"xpThreshold": 0, "name": "Bronze"}, {"xpThreshold": 1000, "name": "Silver"}]'></textarea>
                        </div>
                        <button class="btn btn-success" onclick="saveLevelingSettings()">Save Leveling Settings</button>
                    </div>
                    <div class="card">
                        <h3>Payment Methods</h3>
                        <div id="paymentMethodsListContainer"></div>
                        <div class="form-group" style="display: flex; gap: 10px; margin-top: 15px;">
                            <input type="text" id="newPaymentMethodName" placeholder="e.g., Bkash">
                            <button class="btn btn-primary" onclick="addPaymentMethod()">Add</button>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Notices & Maintenance</h3>
                        <div class="form-group">
                            <label><input type="checkbox" id="settingNoticeActive"> Show Global Notice</label>
                            <textarea id="settingGlobalNotice" rows="3" placeholder="Enter notice text here..."></textarea>
                        </div>
                         <div class="form-group">
                            <label><input type="checkbox" id="settingMaintenanceMode"> Enable Maintenance Mode</label>
                            <textarea id="settingMaintenanceMessage" rows="3" placeholder="Enter maintenance message..."></textarea>
                        </div>
                        <button class="btn btn-success" onclick="saveNoticeSettings()">Save Notice & Maintenance</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
        apiKey: "AIzaSyDfn1veuHMeHCbqgYQs_KEREDgwVmBxSHw",
        authDomain: "the-arafat-earnings.firebaseapp.com",
        databaseURL: "https://the-arafat-earnings-default-rtdb.firebaseio.com",
        projectId: "the-arafat-earnings",
        storageBucket: "the-arafat-earnings.firebasestorage.app",
        messagingSenderId: "1082223011616",
        appId: "1:1082223011616:web:3de7e7438ca002dda6d945",
        measurementId: "G-T9NY7D2RW8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        const ADMIN_PASSWORD = "Admin@2025JR";

        let allUsersData = {}, allWithdrawalsData = {}, selectedUserId = null, appConfig = {};
        
        function login() {
            if (document.getElementById('adminPassword').value === ADMIN_PASSWORD) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('adminContainer').style.display = 'flex';
                initializeApp();
            } else { alert('Incorrect Password!'); }
        }

        function toggleSidebar() { document.getElementById('adminBody').classList.toggle('sidebar-open'); }

        function showSection(sectionId, title) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId + '-section').classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            const menuItem = document.querySelector(`.menu-item[data-section="${sectionId}"]`);
            if (menuItem) {
                menuItem.classList.add('active');
                document.getElementById('topbarTitle').innerText = title;
            }
            if (window.innerWidth <= 768) toggleSidebar();
        }

        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionId = e.currentTarget.dataset.section;
                const title = e.currentTarget.innerText.trim();
                showSection(sectionId, title);
            });
        });
        
        document.getElementById('withdrawalTabNav').addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-nav-item')) {
                const status = e.target.dataset.status;
                document.querySelectorAll('#withdrawalTabNav .tab-nav-item').forEach(tab => tab.classList.remove('active'));
                e.target.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`withdrawalTabContent${status.charAt(0).toUpperCase() + status.slice(1)}`).classList.add('active');
            }
        });

        function initializeApp() {
            db.ref('users').on('value', (snapshot) => {
                allUsersData = snapshot.val() || {};
                renderUsersList();
                document.getElementById('userCount').innerText = Object.keys(allUsersData).length;
                updateDashboardAnalytics();
            });
            db.ref('config').on('value', (snapshot) => {
                if(snapshot.exists()){
                    appConfig = snapshot.val();
                    document.getElementById('settingAppName').value = appConfig.APP_NAME || '';
                    document.getElementById('settingAppVersion').value = appConfig.appVersion || '';
                    document.getElementById('settingDevLink').value = appConfig.DEVELOPER_TELEGRAM_PROFILE_LINK || '';
                    document.getElementById('settingOfficialChannelLink').value = appConfig.OFFICIAL_CHANNEL_LINK || '';
                    document.getElementById('settingSupportGroupLink').value = appConfig.SUPPORT_GROUP_LINK || '';
                    document.getElementById('settingRefBotLink').value = appConfig.REFERRAL_BOT_LINK || '';
                    document.getElementById('settingPointsPerAd').value = appConfig.POINTS_PER_AD || 0;
                    document.getElementById('settingAdsPerDay').value = appConfig.ADS_PER_DAY_LIMIT || 0;
                    document.getElementById('settingMinWithdraw').value = appConfig.MIN_WITHDRAW_POINTS || 0;
                    document.getElementById('settingDailyBonus').value = appConfig.dailyBonusAmount || 0;
                    document.getElementById('settingRefBonusReferrer').value = appConfig.REFERRAL_BONUS_REFERRER || 0;
                    document.getElementById('settingRefBonusReferee').value = appConfig.REFERRAL_BONUS_REFEREE || 0;
                    document.getElementById('settingMonetagZoneId').value = appConfig.MONETAG_ZONE_ID || '';
                    document.getElementById('settingNoticeActive').checked = appConfig.isNoticeActive || false;
                    document.getElementById('settingGlobalNotice').value = appConfig.globalNoticeText || '';
                    document.getElementById('settingMaintenanceMode').checked = appConfig.isMaintenanceMode || false;
                    document.getElementById('settingMaintenanceMessage').value = appConfig.maintenanceMessage || '';
                    if (appConfig.levelingConfig) {
                        document.getElementById('settingXpPerAd').value = appConfig.levelingConfig.xpPerAd || 10;
                        document.getElementById('settingLevelConfig').value = JSON.stringify(appConfig.levelingConfig.levels, null, 2);
                    }
                    renderPaymentMethods();
                }
            });
            db.ref('bonusChannels').on('value', (snapshot) => {
                const container = document.getElementById('bonusChannelsListContainer'); container.innerHTML = '';
                const channels = snapshot.val() || {};
                Object.values(channels).forEach(channel => {
                    const el = document.createElement('div'); el.className = 'list-item';
                    el.innerHTML = `<div class="list-item-header">${channel.name} (+${channel.reward})</div><div class="list-item-subheader">ID: ${channel.id}</div><button class="btn btn-warning btn-sm" style="padding: 5px 10px;" onclick="editBonusChannel('${channel.id}', '${channel.name}', '${channel.link}', ${channel.reward}, '${channel.icon}')">Edit</button><button class="btn btn-danger btn-sm" style="padding: 5px 10px;" onclick="deleteBonusChannel('${channel.id}')">Delete</button>`;
                    container.appendChild(el);
                });
            });

            db.ref('withdrawals').orderByChild('timestamp').on('value', (snapshot) => {
                 allWithdrawalsData = snapshot.val() || {};
                 renderAllWithdrawals();
                 updateDashboardAnalytics();
                 if (selectedUserId) showUserDetails(selectedUserId);
            });
        }
        
        function renderAllWithdrawals() {
            const containerPending = document.getElementById('withdrawalTabContentPending');
            const containerPaid = document.getElementById('withdrawalTabContentPaid');
            const containerRejected = document.getElementById('withdrawalTabContentRejected');
            containerPending.innerHTML = ''; containerPaid.innerHTML = ''; containerRejected.innerHTML = '';

            const requests = Object.entries(allWithdrawalsData).reverse();

            let pendingCount = 0, paidCount = 0, rejectedCount = 0;

            requests.forEach(([reqId, req]) => {
                const el = document.createElement('div');
                el.className = 'list-item';
                
                if (req.status === 'pending') {
                    el.innerHTML = `<div class="list-item-header">${req.userName} - ${req.points} Points</div><div class="list-item-subheader">${req.method}: ${req.account} | UserID: ${req.userId}</div><button class="btn btn-success" onclick="markAsPaid('${reqId}')">Paid</button><button class="btn btn-danger" onclick="rejectWithdrawal('${reqId}', '${req.userId}', ${req.points})">Reject</button>`;
                    containerPending.appendChild(el);
                    pendingCount++;
                } else if (req.status === 'paid') {
                    el.innerHTML = `<div class="list-item-header">${req.userName} - ${req.points} Points</div><div class="list-item-subheader">${req.method}: ${req.account} | Status: <span style="color: green;">Paid</span></div>`;
                    containerPaid.appendChild(el);
                    paidCount++;
                } else if (req.status === 'rejected') {
                    el.innerHTML = `<div class="list-item-header">${req.userName} - ${req.points} Points</div><div class="list-item-subheader">${req.method}: ${req.account} | Status: <span style="color: red;">Rejected</span></div>`;
                    containerRejected.appendChild(el);
                    rejectedCount++;
                }
            });

            document.getElementById('withdrawalCountPending').innerText = pendingCount;
            document.getElementById('withdrawalCountPaid').innerText = paidCount;
            document.getElementById('withdrawalCountRejected').innerText = rejectedCount;
        }

        function updateDashboardAnalytics() {
            const totalUsers = Object.keys(allUsersData).length; document.getElementById('analyticsTotalUsers').innerText = totalUsers;
            const today = new Date().toISOString().slice(0, 10);
            const newUsersToday = Object.values(allUsersData).filter(u => u.registrationDate && u.registrationDate.startsWith(today)).length; document.getElementById('analyticsNewUsersToday').innerText = newUsersToday;
            const pendingWithdrawals = Object.values(allWithdrawalsData).filter(req => req.status === 'pending').length; document.getElementById('analyticsPendingWithdrawals').innerText = pendingWithdrawals;
            const totalPoints = Object.values(allUsersData).reduce((sum, user) => sum + (user.points || 0), 0); document.getElementById('analyticsTotalPoints').innerText = totalPoints.toLocaleString();
        }
        async function saveGeneralSettings() { const updates = { APP_NAME: document.getElementById('settingAppName').value, appVersion: document.getElementById('settingAppVersion').value, DEVELOPER_TELEGRAM_PROFILE_LINK: document.getElementById('settingDevLink').value, OFFICIAL_CHANNEL_LINK: document.getElementById('settingOfficialChannelLink').value, SUPPORT_GROUP_LINK: document.getElementById('settingSupportGroupLink').value, REFERRAL_BOT_LINK: document.getElementById('settingRefBotLink').value, }; await db.ref('config').update(updates); alert('General settings updated!'); }
        async function savePointsSettings() { const updates = { POINTS_PER_AD: parseInt(document.getElementById('settingPointsPerAd').value), ADS_PER_DAY_LIMIT: parseInt(document.getElementById('settingAdsPerDay').value), MIN_WITHDRAW_POINTS: parseInt(document.getElementById('settingMinWithdraw').value), dailyBonusAmount: parseInt(document.getElementById('settingDailyBonus').value), REFERRAL_BONUS_REFERRER: parseInt(document.getElementById('settingRefBonusReferrer').value), REFERRAL_BONUS_REFEREE: parseInt(document.getElementById('settingRefBonusReferee').value), MONETAG_ZONE_ID: document.getElementById('settingMonetagZoneId').value.trim() }; await db.ref('config').update(updates); alert('Points & Ad settings updated!'); }
        
        async function saveLevelingSettings() {
            try {
                const levels = JSON.parse(document.getElementById('settingLevelConfig').value);
                const xpPerAd = parseInt(document.getElementById('settingXpPerAd').value);
                if (!Array.isArray(levels) || xpPerAd < 0) {
                    throw new Error("Invalid format");
                }
                const updates = { levelingConfig: { xpPerAd, levels } };
                await db.ref('config').update(updates);
                alert('Leveling settings updated!');
            } catch(e) {
                alert('Invalid JSON format for Level Thresholds. Please check your input.');
            }
        }

        async function saveNoticeSettings() { const updates = { isNoticeActive: document.getElementById('settingNoticeActive').checked, globalNoticeText: document.getElementById('settingGlobalNotice').value, isMaintenanceMode: document.getElementById('settingMaintenanceMode').checked, maintenanceMessage: document.getElementById('settingMaintenanceMessage').value, }; await db.ref('config').update(updates); alert('Notice & Maintenance settings updated!'); }
        async function sendPersonalNotice() { if (!selectedUserId) return alert('No user selected.'); const message = document.getElementById('personalNoticeMessage').value; if (!message.trim()) return alert('Message cannot be empty.'); const notice = { message: message, timestamp: new Date().getTime() }; await db.ref(`users/${selectedUserId}/personalNotice`).set(notice); document.getElementById('personalNoticeMessage').value = ''; alert('Personal notice sent successfully!'); }
        function renderPaymentMethods() { const container = document.getElementById('paymentMethodsListContainer'); container.innerHTML = ''; const methods = appConfig.PAYMENT_METHODS || []; methods.forEach(method => { const el = document.createElement('div'); el.className = 'list-item'; el.innerHTML = `<span>${method.name}</span><button class="btn btn-danger btn-sm" style="padding: 5px 10px;" onclick="deletePaymentMethod('${method.name}')">Delete</button>`; container.appendChild(el); }); }
        async function addPaymentMethod() { const newName = document.getElementById('newPaymentMethodName').value.trim(); if (!newName) return alert('Method name is required.'); let methods = appConfig.PAYMENT_METHODS || []; if (methods.some(m => m.name.toLowerCase() === newName.toLowerCase())) return alert('This method already exists.'); methods.push({ name: newName }); await db.ref('config/PAYMENT_METHODS').set(methods); document.getElementById('newPaymentMethodName').value = ''; alert('Payment method added!'); }
        async function deletePaymentMethod(nameToDelete) { if (!confirm(`Are you sure you want to delete "${nameToDelete}"?`)) return; let methods = (appConfig.PAYMENT_METHODS || []).filter(m => m.name !== nameToDelete); await db.ref('config/PAYMENT_METHODS').set(methods); alert('Payment method deleted!'); }
        function renderUsersList() { const container = document.getElementById('usersListContainer'); const searchTerm = document.getElementById('userSearch').value.toLowerCase(); container.innerHTML = ''; const sortedUsers = Object.entries(allUsersData).sort(([,a], [,b]) => (b.points || 0) - (a.points || 0)); sortedUsers.forEach(([userId, user]) => { if (user.name.toLowerCase().includes(searchTerm) || userId.toLowerCase().includes(searchTerm)) { const el = document.createElement('div'); el.className = 'list-item'; if (userId === selectedUserId) el.classList.add('active'); el.setAttribute('onclick', `showUserDetails('${userId}')`); el.innerHTML = `<div class="list-item-header">${user.name} ${user.isBlocked ? '<span style="color:red;">(Blocked)</span>' : ''}</div><div class="list-item-subheader">Points: ${user.points || 0} | Level: ${user.level || 1} | ID: ${userId}</div>`; container.appendChild(el); } }); }
        
        function showUserDetails(userId) { 
            selectedUserId = userId; 
            const user = allUsersData[userId]; 
            document.getElementById('userDetailsCard').style.display = 'block'; 
            document.getElementById('detailUserId').value = userId; 
            document.getElementById('detailUserName').value = user.name; 
            document.getElementById('detailUserPoints').value = user.points || 0; 
            document.getElementById('detailUserLevel').value = user.level || 1;
            document.getElementById('detailUserXp').value = user.xp || 0;
            const blockBtn = document.getElementById('blockUserBtn'); 
            blockBtn.textContent = user.isBlocked ? 'Unblock User' : 'Block User'; 
            blockBtn.className = `btn ${user.isBlocked ? 'btn-success' : 'btn-warning'}`; 
            document.getElementById('detailUserRegistrationDate').innerText = user.registrationDate ? new Date(user.registrationDate).toLocaleString() : 'N/A'; 
            document.getElementById('detailUserLastLogin').innerText = user.lastLoginDate ? new Date(user.lastLoginDate).toLocaleString() : 'N/A'; 
            const refCount = user.referredUsers ? user.referredUsers.length : 0; 
            document.getElementById('detailUserReferralCount').innerText = refCount; 
            const refContainer = document.getElementById('detailUserReferralHistory'); 
            refContainer.innerHTML = ''; 
            if (refCount > 0) user.referredUsers.forEach(code => { refContainer.innerHTML += `<div class="history-item">Referred code: ${code}</div>`; }); else refContainer.innerHTML = '<p>No referrals yet.</p>'; 
            
            const transactionContainer = document.getElementById('detailUserTransactionHistory');
            transactionContainer.innerHTML = 'Loading...';
            db.ref('transactionLogs/' + userId).orderByChild('timestamp').limitToLast(50).once('value', (snapshot) => {
                transactionContainer.innerHTML = '';
                if(snapshot.exists()) {
                    const logs = Object.values(snapshot.val()).reverse();
                    logs.forEach(log => {
                        const sign = log.type === 'credit' ? '+' : '-';
                        const color = log.type === 'credit' ? 'green' : 'red';
                        transactionContainer.innerHTML += `<div class="history-item"><span style="color: ${color};">${sign}${log.amount}</span>: ${log.description} <i>(${new Date(log.timestamp).toLocaleString()})</i></div>`;
                    });
                } else {
                    transactionContainer.innerHTML = '<p>No transaction history.</p>';
                }
            });

            renderUsersList(); 
        }

        async function saveUserDetails() { 
            if (!selectedUserId) return; 
            await db.ref('users/' + selectedUserId).update({ 
                name: document.getElementById('detailUserName').value, 
                points: parseInt(document.getElementById('detailUserPoints').value),
                level: parseInt(document.getElementById('detailUserLevel').value),
                xp: parseInt(document.getElementById('detailUserXp').value)
            }); 
            alert('User details updated!'); 
        }

        async function deleteUser() { if (!selectedUserId || !confirm(`Delete user ${allUsersData[selectedUserId].name}?`)) return; await db.ref('users/' + selectedUserId).remove(); await db.ref('transactionLogs/' + selectedUserId).remove(); document.getElementById('userDetailsCard').style.display = 'none'; selectedUserId = null; alert('User deleted!'); }
        async function toggleBlockUser() { if (!selectedUserId) return; const user = allUsersData[selectedUserId]; const newStatus = !user.isBlocked; if (!confirm(`Are you sure to ${newStatus ? 'block' : 'unblock'} this user?`)) return; await db.ref(`users/${selectedUserId}`).update({ isBlocked: newStatus }); alert(`User ${newStatus ? 'blocked' : 'unblocked'}!`); }
        function editBonusChannel(id, name, link, reward, icon) { document.getElementById('bonusId').value = id; document.getElementById('bonusId').readOnly = true; document.getElementById('bonusName').value = name; document.getElementById('bonusLink').value = link; document.getElementById('bonusReward').value = reward; document.getElementById('bonusIcon').value = icon; const saveButton = document.querySelector('#bonus-section .btn-primary'); saveButton.innerText = 'Update Channel'; document.getElementById('bonusId').focus(); }
        async function saveBonusChannel() {
            const id = document.getElementById('bonusId').value.trim();
            const name = document.getElementById('bonusName').value.trim();
            const link = document.getElementById('bonusLink').value.trim();
            const reward = parseInt(document.getElementById('bonusReward').value);
            const icon = document.getElementById('bonusIcon').value.trim();
            if (!id || !name || !link || !reward || !icon) return alert('Please fill all fields.');
            await db.ref('bonusChannels/' + id).set({ id, name, link, reward, icon });
            const idInput = document.getElementById('bonusId'); idInput.readOnly = false;
            const saveButton = document.querySelector('#bonus-section .btn-primary'); saveButton.innerText = 'Add New Channel';
            alert('Bonus channel saved!');
            document.getElementById('bonusId').value = ''; document.getElementById('bonusName').value = ''; document.getElementById('bonusLink').value = ''; document.getElementById('bonusReward').value = ''; document.getElementById('bonusIcon').value = '';
        }
        async function deleteBonusChannel(channelId) { if (!confirm(`Delete bonus channel ID: ${channelId}?`)) return; await db.ref('bonusChannels/' + channelId).remove(); alert('Bonus channel deleted.'); }
        async function markAsPaid(reqId) { if (!confirm('Mark as paid?')) return; await db.ref(`withdrawals/${reqId}`).update({ status: 'paid' }); alert('Request marked as paid.'); }
        
        async function rejectWithdrawal(reqId, userId, points) { 
            if (!confirm('Reject request and refund points?')) return; 
            
            const logEntry = {
                timestamp: new Date().toISOString(),
                type: 'credit',
                amount: points,
                description: 'Withdrawal Rejected (Refund)'
            };
            await db.ref(`transactionLogs/${userId}`).push(logEntry);

            await db.ref(`users/${userId}/points`).set(firebase.database.ServerValue.increment(points)); 
            await db.ref(`withdrawals/${reqId}`).update({ status: 'rejected' }); 
            alert('Request rejected and points refunded.'); 
        }
    </script>
</body>
</html>
